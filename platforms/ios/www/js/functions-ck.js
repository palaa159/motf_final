/////////////// MAP ////////////////
var southEast=new L.LatLng(40.780899,-73.840369),northWest=new L.LatLng(40.845863,-73.924432),bounds=new L.LatLngBounds(southEast,northWest),mapView={lat:null,lng:null,newLatLng:null,map:null,myPos:null,videoNodes:null,UGCNode:null,zoomUGC:function(e){mapView.map.invalidateSize();mapView.map.setView([motf.UGCData[e].lat,motf.UGCData[e].lng],15);mapView.UGCNode[e].openPopup()},zoom:function(e){mapView.map.setView(motf.videoData[e].geoData,16);mapView.map.invalidateSize();mapView.videoNodes[e].openPopup()},init:function(e){e==undefined&&(e=[40.816911,-73.887223]);console.log("map init");this.map=new L.map("map",{center:e,minZoom:14,zoom:15,zoomControl:!1});this.map.setMaxBounds(bounds);L.tileLayer("http://a.tiles.mapbox.com/v3/palaa159.gaehc27p/{z}/{x}/{y}.png",{detectRetina:!0,reuseTiles:!0}).addTo(mapView.map);mapView.myPos=(new L.circleMarker([0,0],{stroke:!1,fillColor:"#fb0005",fillOpacity:1,radius:5})).bindPopup("This is YOU").addTo(mapView.map);mapView.map.invalidateSize()},detectUserLocation:function(){function t(e){var t={1:"Permission denied",2:"Position unavailable",3:"Request timeout"};sys.os=="web"&&alert("Geolocation error")}if(navigator.geolocation){var e=1e7;navigator.geolocation.watchPosition(mapView.mapToPosition,t,{enableHighAccuracy:!0,timeout:e,maximumAge:0})}else alert("Geolocation is not supported by this browser")},mapToPosition:function(e){mapView.lng=e.coords.longitude;mapView.lat=e.coords.latitude;mapView.newLatLng=new L.LatLng(mapView.lat,mapView.lng);mapView.myPos.setLatLng(mapView.newLatLng);bounds.contains(mapView.newLatLng)?$("#clientLocate").fadeIn():$("#clientLocate").fadeOut();mapView.mapFullOpacity()},feedVideo:function(){mapView.videoNodes=[];$.each(motf.videoData,function(e,t){var n=t.ID;e!==0&&(mapView.videoNodes[e]=L.marker(t.geoData,{}).bindLabel(n.toString(),{noHide:!0}).bindPopup('<a onclick="mapView.setCurrDataOnMap('+e+');">  <div id="chevron"></div>    <div class="contextualView">'+t.author+"<br>"+t.address+"</div></a>").addTo(mapView.map))});mapView.map.invalidateSize()},feedUGC:function(){mapView.UGCNode=[];$.each(motf.UGCData,function(e,t){t.approval&&(mapView.UGCNode[e]=L.marker([t.lat+.001,t.lng],{icon:mapView.UGCIcon}).bindPopup('<a onclick="mapView.setCurrUGCData('+e+');"><div id="chevron"></div><div class="contextualView">'+t.title+"</div></a>").addTo(mapView.map))})},setCurrDataOnMap:function(e){motf.currPoet=e;motf.goToPage("pPoetDetail")},setCurrUGCData:function(e){motf.currUGCData=e;motf.goToPage("pUGCPoetDetail")},videoIcon:L.icon({iconUrl:"js/vendor/images/marker-icon-2x.png",iconSize:[20,32],iconAnchor:[18,18],popupAnchor:[-6,-15]}),UGCIcon:L.icon({iconUrl:"js/vendor/images/ugc-icon-2x.png",iconSize:[19,30],popupAnchor:[0,-15]}),clientLocate:function(){mapView.map.setView(mapView.newLatLng,16)},mapHalfOpacity:function(){$("#map").animate({opacity:.5})},mapFullOpacity:function(){$("#map").animate({opacity:1})}},detailMap={map:null,marker:null,init:function(){this.map=L.map("detailNodeMap",{dragging:!1,touchZoom:!1,tap:!1,doubleClickZoom:!1,center:motf.videoData[0].geoData,zoomControl:!1,zoom:15});L.tileLayer("http://a.tiles.mapbox.com/v3/palaa159.gaehc27p/{z}/{x}/{y}.png",{detectRetina:!0,reuseTiles:!0}).addTo(detailMap.map);detailMap.marker=L.marker(motf.videoData[0].geoData).bindLabel(motf.videoData[0].ID.toString(),{noHide:!0});detailMap.map.addLayer(detailMap.marker);detailMap.map.invalidateSize()},zoom:function(e){detailMap.map.removeLayer(detailMap.marker);detailMap.marker=L.marker(motf.videoData[e].geoData).bindLabel(motf.videoData[e].ID.toString(),{noHide:!0});detailMap.map.addLayer(detailMap.marker);detailMap.map.setView(motf.videoData[e].geoData,16)}},UGCMapView={map:null,lat:null,lng:null,init:function(){this.map=new L.Map("ugcMap",{center:[40.816911,-73.887223],minZoom:14,zoom:15,zoomControl:!1});this.map.setMaxBounds(bounds);L.tileLayer("http://a.tiles.mapbox.com/v3/palaa159.gaehc27p/{z}/{x}/{y}.png",{detectRetina:!0,reuseTiles:!0}).addTo(this.map);$("#ugcMap").animate({opacity:1})},capture:function(){var e=$("#ugcMap").width()/2,t=$("#ugcMap").height()/2+13;this.lat=this.map.containerPointToLatLng([e,t]).lat;this.lng=this.map.containerPointToLatLng([e,t]).lng;console.warn("@@@ capture >>> "+this.lat+", "+this.lng)}},parse={videoObj:Parse.Object.extend("firstPhase"),UGCObj:Parse.Object.extend("ugc"),video:null,UGC:null,init:function(){Parse.initialize("LcwUW1mhSbxh25gcPfHKFENrbt6YegsB8bxF5VJZ","lewWw2HFlo1kk9qnJy1y1OrWfZGVNjSTjAfqRF8e");this.video=new this.videoObj;this.UGC=new this.UGCObj},fetchVideo:function(){console.log("fetching video");this.video.fetch({success:function(e){motf.videoData=sortByKey(e._serverData.results,"ID");parse.fetchUGC();motf.goToPage("pPoets")},error:function(e,t){motf.goToPage("pOffline")}})},fetchUGC:function(e){console.log("fetch UGC");this.UGC.fetch({success:function(t){motf.UGCData=null;motf.UGCData=t._serverData.results;e&&$("#submitCover").fadeOut("fast",function(){motf.goToPage("pMapAfterUGC")})},error:function(e,t){motf.UGCData=null;motf.goToPage("pOffline")}})},storeUGC:function(e,t,n,r,i){console.log("storing "+e,t,n,r,i);$("#submitCover").fadeIn();parse.UGC.save({lat:e-9e-4,lng:t,author:n,title:r,content:i,approval:!0},{success:function(e){$("#ugcTitle").val("");$("#ugcContent").val("");$("#ugcAuthor").val("");parse.init();setTimeout(function(){parse.fetchUGC(!0)},3e3)},error:function(e,t){navigator.notification.alert("There is something wrong with the server, Your poem is not stored",function(){motf.goToPage("pageMap")},"Memories of the Future","Dismiss")}})}},checkSystem=function(){var e=/(iPad|iPhone|iPod)/g.test(navigator.userAgent),t=/(iPad|iPhone);.*CPU.*OS 7_\d/i.test(navigator.userAgent),n=navigator.userAgent.toLowerCase(),r=n.indexOf("android")>-1;if(!e&&!t&&!r)return"web";if(t)return"ios7";if(!t&&e)return"ios6";if(r)return"android"},sortByKey=function(e,t){return e.sort(function(e,n){var r=e[t],i=n[t];return r<i?-1:r>i?1:0})},replaceAll=function(e,t,n){return n.replace(new RegExp(e,"g"),t)},makeid=function(){var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var n=0;n<5;n++)n==0?e+=t.charAt(Math.floor(Math.random()*t.length-11)):e+=t.charAt(Math.floor(Math.random()*t.length));return e},centerEl=function(e){return $(e).css({position:"absolute",left:motf.appWidth/2-$(e).outerWidth()/2,top:motf.appHeight/2-$(e).outerHeight()/2})};Handlebars.registerHelper("compare",function(e,t,n,r){var i,s;if(arguments.length<3)throw new Error("Handlerbars Helper 'compare' needs 2 parameters");if(r===undefined){r=n;n=t;t="==="}i={"==":function(e,t){return e==t},"===":function(e,t){return e===t},"!=":function(e,t){return e!=t},"!==":function(e,t){return e!==t},"<":function(e,t){return e<t},">":function(e,t){return e>t},"<=":function(e,t){return e<=t},">=":function(e,t){return e>=t},"typeof":function(e,t){return typeof e==t}};if(!i[t])throw new Error("Handlerbars Helper 'compare' doesn't know the operator "+t);s=i[t](e,n);return s?r.fn(this):r.inverse(this)});Retina=function(){return{init:function(){var e=window.devicePixelRatio?window.devicePixelRatio:1;e>1&&$("img").each(function(e,t){t=$(t);if(t.attr("data-src2x")){t.attr("data-src-orig",t.attr("src"));t.attr("src",t.attr("data-src2x"))}})}}}();Retina.init();